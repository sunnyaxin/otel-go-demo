
services:
  app:
    build: .
    image: otel-go-webapp:latest
    ports:
      - "8080:8080"
    depends_on:
      - otel-collector

  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    command: [ "--config=/etc/otel-collector-config.yaml" ]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
    ports:
      - "4317:4317" # OTLP gRPC receiver
      - "4318:4318" # OTLP HTTP receiver

  # Go Auto-Instrumentation agent container that attaches to the app process
  otel-go-agent:
    image: ghcr.io/open-telemetry/opentelemetry-go-instrumentation/autoinstrumentation-go:latest
    depends_on:
      - app
      - otel-collector
    pid: "service:app"  # 共享目标容器的进程命名空间
    restart: unless-stopped
    privileged: true  # 需要特权模式
    security_opt:
      - apparmor:unconfined
    cap_add:
      - SYS_ADMIN  # 管理内核功能
      - SYS_PTRACE  # 附加到进程
      - SYS_RESOURCE  # 调整资源限制
      - PERFMON # 性能监控
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
      - OTEL_SERVICE_NAME=otel-go-demo
      - OTEL_RESOURCE_ATTRIBUTES=deployment.environment=dev
      - OTEL_GO_AUTO_INSTRUMENTATION_HTTP_ENABLED=true
      - OTEL_GO_AUTO_INSTRUMENTATION_RUNTIME_ENABLED=true
      # Target the app's executable path inside the app container
      - OTEL_GO_AUTO_TARGET_EXE=/usr/local/bin/server
      - OTEL_LOG_LEVEL=debug
    volumes:
      - /sys/kernel/debug:/sys/kernel/debug # eBPF 调试接口
      - /sys/fs/bpf:/sys/fs/bpf # eBPF 文件系统
      - /sys/kernel/tracing:/sys/kernel/tracing # 内核追踪
